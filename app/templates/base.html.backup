{% if is_mobile %}
{% include 'mobile/base.html' %}
{% else %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="OdontoClinic - Sistema de Gerenciamento de ClÃ­nica OdontolÃ³gica">
    <meta name="keywords" content="odontologia, clÃ­nica, dentista, agendamento, pacientes, tratamentos">
    <title>
        {% block title %}OdontoClinic{% endblock %}
    </title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}">
    <style nonce="{{ csp_nonce() }}">
        body {
            min-height: 100vh;
            padding-bottom: 20px;
            background-color: #f8f9fa;
            padding-top: 60px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #ffffff;
            width: 250px;
            transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
        }

        .sidebar-collapsed {
            width: 70px !important;
            min-width: 70px !important;
            overflow-x: hidden;
        }

        .sidebar-collapsed .sidebar-heading,
        .sidebar-collapsed .sidebar-sticky h6,
        .sidebar-collapsed .sidebar .nav-link span,
        .sidebar-collapsed .sidebar .sidebar-heading,
        .sidebar-collapsed .sidebar .sidebar-heading,
        .sidebar-collapsed .sidebar .sidebar-heading,
        .sidebar-collapsed .sidebar .sidebar-heading {
            display: none !important;
        }

        .sidebar-collapsed .nav-link {
            justify-content: center;
            text-align: center;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }

        .sidebar-collapsed .nav-link .bi {
            margin-right: 0 !important;
        }

        .sidebar .nav-link {
            font-weight: 500;
            color: #333;
            padding: .75rem 1rem;
            display: flex;
            align-items: center;
            transition: background 0.2s, color 0.2s;
        }

        .sidebar .nav-link.active {
            color: #2470dc;
            background: #f0f4ff;
        }

        .sidebar .nav-link:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .sidebar .nav-link .bi {
            margin-right: 8px;
        }

        .sidebar .dropdown-toggle::after {
            margin-left: auto;
        }

        .sidebar .dropdown-menu {
            position: static;
            float: none;
            box-shadow: none;
            background: #f8f9fa;
            border: none;
            margin: 0;
            padding-left: 2rem;
        }

        .sidebar-heading {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d !important;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .main-content {
            padding-top: 20px;
        }

        @media (max-width: 991px) {
            .sidebar {
                display: block !important;
                position: fixed;
                z-index: 2000;
                background: #fff;
                left: 0;
                top: 0;
                height: 100vh;
                width: 250px;
                transition: left 0.3s cubic-bezier(.4, 0, .2, 1);
            }

            .sidebar.sidebar-collapsed {
                left: -250px;
            }

            .main-content {
                margin-left: 0;
            }

            #sidebarCollapseBtn {
                top: 10px;
                left: 220px;
                right: auto;
                z-index: 2100;
            }
        }

        .submenu-accordion {
            display: none;
            margin-bottom: 0.5rem;
        }

        .submenu-accordion.show {
            display: block;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Flash Messages will be positioned properly to avoid being hidden -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="container flash-container flash-messages-container">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    {% if current_user.is_authenticated %}
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <button id="sidebarCollapseBtn" class="btn btn-light me-2"
                style="box-shadow:0 2px 6px rgba(0,0,0,0.08);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;">
                <i class="bi bi-chevron-left" id="sidebarCollapseIcon"></i>
            </button>
            <a class="navbar-brand" href="{{ url_for('main.dashboard') }}"><i class="bi bi-hospital"></i>OdontoClinic
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item me-2">
                        <button id="theme-toggle-button" class="nav-link btn" style="font-size: 1.25rem;">
                            ðŸŒ™ <!-- Default: Moon icon for light mode -->
                        </button>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-circle"></i> {{
                            current_user.nome_completo }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('users.meu_perfil') }}"><i
                                        class="bi bi-person"></i>Meu Perfil</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('main.settings') }}"><i
                                        class="bi bi-gear"></i>ConfiguraÃ§Ãµes</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i
                                        class="bi bi-box-arrow-right"></i>Sair </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar responsivo -->
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-block sidebar">
                <div class="sidebar-sticky">
                    <div class="sidebar-heading px-3">Menu Principal</div>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint.startswith('main.') %}active{% endif %}"
                                href="{{ url_for('main.dashboard') }}"><i class="bi bi-speedometer2"></i>Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link d-flex align-items-center {% if request.endpoint.startswith('pacientes.') %}active{% endif %}"
                               href="#" onclick="toggleAccordionMenu(event, 'pacientesAccordionMenu')">
                                <i class="bi bi-people"></i>Pacientes
                                <i class="bi ms-auto {% if request.endpoint.startswith('pacientes.') %}bi-chevron-up{% else %}bi-chevron-down{% endif %}" id="pacientesAccordionIcon"></i>
                            </a>
                            <ul class="nav flex-column ms-4 submenu-accordion {% if request.endpoint.startswith('pacientes.') %}show{% else %}collapse{% endif %}" id="pacientesAccordionMenu">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.endpoint == 'pacientes.lista_pacientes' %}active{% endif %}" href="{{ url_for('pacientes.listar_pacientes') }}">
                                        <i class="bi bi-list-ul"></i> Lista de Pacientes
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link {% if request.endpoint == 'pacientes.aniversarios' %}active{% endif %}" href="{{ url_for('pacientes.aniversarios') }}">
                                        <i class="bi bi-gift"></i> AniversÃ¡rios
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="bi bi-calendar-week"></i>Agenda</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="bi bi-currency-dollar"></i>Financeiro</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('tratamentos.lista_categorias') }}"><i class="bi bi-clipboard2-plus"></i>Tratamentos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint.startswith('receitas.') %}active{% endif %}" href="{{ url_for('receitas.index') }}"><i class="bi bi-prescription2"></i>Receitas</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link d-flex align-items-center" href="#" onclick="toggleAccordionMenu(event, 'extrasAccordionMenu')">
                                <i class="bi bi-stars"></i>Extras
                                <i class="bi ms-auto {% if request.endpoint.startswith('cro.') or request.endpoint.startswith('calculadora_anestesico') %}bi-chevron-up{% else %}bi-chevron-down{% endif %}" id="extrasAccordionIcon"></i>
                            </a>
                            <ul class="nav flex-column ms-4 submenu-accordion {% if request.endpoint.startswith('cro.') or request.endpoint.startswith('calculadora_anestesico') %}show{% else %}collapse{% endif %}" id="extrasAccordionMenu">
                                <li class="nav-item">
                                    <a class="nav-link {% if request.endpoint.startswith('cro.') %}active{% endif %}" href="{{ url_for('cro.index') }}">
                                        <i class="bi bi-card-list"></i> CRO
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link {% if request.endpoint.startswith('calculadora_anestesico') %}active{% endif %}" href="{{ url_for('main.calculadora_anestesico') }}">
                                        <i class="bi bi-calculator"></i> Calculadora de AnestÃ©sico
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <div class="sidebar-heading px-3">AdministraÃ§Ã£o</div>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint.startswith('users.') %}active{% endif %}"
                                href="{{ url_for('users.listar_usuarios') }}"><i class="bi bi-person-badge"></i>UsuÃ¡rios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'main.settings' %}active{% endif %}"
                                href="{{ url_for('main.settings') }}"><i class="bi bi-gear"></i>ConfiguraÃ§Ãµes</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="bi bi-file-earmark-bar-graph"></i>RelatÃ³rios</a>
                        </li>
                    </ul>
                </div>
            </nav>
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    {% else %}
    <!-- Content for non-authenticated users -->
    <div class="container mt-5">
        {% block auth_content %}{% endblock %}
    </div>
    {% endif %}
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        nonce="{{ csp_nonce() }}"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" nonce="{{ csp_nonce() }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js" nonce="{{ csp_nonce() }}"></script>
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}" nonce="{{ csp_nonce() }}"></script>
    <script nonce="{{ csp_nonce() }}">
        document.addEventListener('DOMContentLoaded', function () {

            // Auto-hide flash messages after 8 seconds (increased from 5 seconds)
            setTimeout(function () {
                const flashMessages = document.querySelectorAll('.flash-messages-container .alert');
                flashMessages.forEach(function (flashMessage) {
                    var alert = new bootstrap.Alert(flashMessage);
                    alert.close();
                });
            }, 8000);

            // Initialize flatpickr for date picker
            flatpickr(".datepicker", {
                dateFormat: "d/m/Y",
                locale: "pt",
                allowInput: true,
                altInput: true,
                altFormat: "d/m/Y",
            });

            // Initialize flatpickr for time picker
            flatpickr(".timepicker", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                locale: "pt",
                allowInput: true,
                altInput: true,
                altFormat: "H:i",
            });

            // Dismiss flash messages on click
            document.addEventListener('click', function (event) {
                if (event.target.classList.contains('btn-close')) {
                    var alert = event.target.closest('.alert');
                    if (alert) {
                        var bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }
            });
        });

        function toggleAccordionMenu(event, submenuId) {
            event.preventDefault();
            var submenu = document.getElementById(submenuId);
            var icon = event.currentTarget.querySelector('i.ms-auto');
            if (submenu.classList.contains('show')) {
                submenu.classList.remove('show');
                submenu.classList.add('collapse');
                if(icon) { icon.classList.remove('bi-chevron-up'); icon.classList.add('bi-chevron-down'); }
            } else {
                submenu.classList.add('show');
                submenu.classList.remove('collapse');
                if(icon) { icon.classList.remove('bi-chevron-down'); icon.classList.add('bi-chevron-up'); }
            }
        }

        // Sidebar collapse/expand
        (function() {
            const sidebar = document.getElementById('sidebarMenu');
            const collapseBtn = document.getElementById('sidebarCollapseBtn');
            const collapseIcon = document.getElementById('sidebarCollapseIcon');
            if (sidebar && collapseBtn && collapseIcon) {
                collapseBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('sidebar-collapsed');
                    if (sidebar.classList.contains('sidebar-collapsed')) {
                        collapseIcon.classList.remove('bi-chevron-left');
                        collapseIcon.classList.add('bi-chevron-right');
                    } else {
                        collapseIcon.classList.remove('bi-chevron-right');
                        collapseIcon.classList.add('bi-chevron-left');
                    }
                    // Opcional: salvar preferÃªncia no localStorage
                    if (window.localStorage) {
                        localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('sidebar-collapsed'));
                    }
                });
                // Restaurar preferÃªncia
                if (window.localStorage && localStorage.getItem('sidebar-collapsed') === 'true') {
                    sidebar.classList.add('sidebar-collapsed');
                    collapseIcon.classList.remove('bi-chevron-left');
                    collapseIcon.classList.add('bi-chevron-right');
                }
            }
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>
{% endif %}
